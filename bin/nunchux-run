#!/usr/bin/env bash
#
# nunchux-run - Run a command with parent shell environment
#
# This script handles environment inheritance for nunchux-go.

# Chuck Norris programming facts (for error screens)
CHUCK_FACTS=(
  "Chuck Norris can unit test entire applications with a single assert."
  "Chuck Norris doesn't use web frameworks. The internet obeys him."
  "Chuck Norris can delete the root folder and still boot."
  "Chuck Norris's code doesn't follow conventions. Conventions follow his code."
  "Chuck Norris can instantiate an abstract class."
  "Chuck Norris doesn't need sudo. The system always trusts him."
  "Chuck Norris can divide by zero."
  "When Chuck Norris throws an exception, nothing can catch it."
  "Chuck Norris's keyboard doesn't have a Ctrl key. He's always in control."
  "Chuck Norris can compile syntax errors."
  "Chuck Norris doesn't need garbage collection. Memory is too afraid to leak."
  "Chuck Norris can read from /dev/null."
  "Chuck Norris finished World of Warcraft."
  "Chuck Norris can write infinite loops that finish in under 2 seconds."
  "Chuck Norris's code is self-documenting. In binary."
  "Chuck Norris doesn't pair program. The code pairs with him."
  "When Chuck Norris git pushes, the remote pulls."
  "Chuck Norris can access private methods. Publicly."
  "Chuck Norris doesn't get compiler errors. The compiler gets Chuck Norris errors."
  "Chuck Norris can make a class that is both abstract and final."
)

# Get a random Chuck Norris fact
random_chuck_fact() {
  echo "${CHUCK_FACTS[$RANDOM % ${#CHUCK_FACTS[@]}]}"
}

# Apply parent environment from tmux's NUNCHUX_ENV_FILE
_nunchux_apply_env() {
  local env_file name value

  # Get env file path from tmux environment (set by keybinding)
  env_file=$(tmux show-environment NUNCHUX_ENV_FILE 2>/dev/null | cut -d= -f2 || true)

  if [[ -z "$env_file" || ! -r "$env_file" ]]; then
    return 0 # No env file available, continue without it
  fi

  # Read and apply environment, filtering problematic variables
  while IFS='=' read -r name value; do
    # Skip empty lines
    [[ -z "$name" ]] && continue

    # Skip variables that could cause issues
    case "$name" in
    # Bash internal variables
    BASH* | SHELLOPTS | FUNCNAME | GROUPS | DIRSTACK)
      continue
      ;;
    # Process/shell state
    EUID | UID | PPID | SHELL | SHLVL | _ | PWD | OLDPWD | PATH)
      continue
      ;;
    # Tmux internal variables
    TMUX | TMUX_PANE | TERM)
      continue
      ;;
    esac

    # Export the variable
    export "$name=$value"
  done <"$env_file"
}

# Detect if we're being sourced or executed
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  # Executed directly: apply env and run command
  set -euo pipefail
  _nunchux_apply_env
  exec "$@"
else
  # Sourced: just apply env
  _nunchux_apply_env
fi

# vim: ft=bash ts=2 sw=2 et
